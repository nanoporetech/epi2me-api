/**
 * Copyright Metrichor Ltd. (An Oxford Nanopore Technologies Company) 2020
 */

import{merge as t,assign as e,filter as n,every as r,isFunction as o,defaults as s}from"lodash";import{BehaviorSubject as i,combineLatest as a}from"rxjs";import u from"graphql-tag";import{InMemoryCache as c}from"apollo-cache-inmemory";import l from"apollo-client";import{ApolloLink as h,execute as p}from"apollo-link";import{createHttpLink as f}from"apollo-link-http";import{buildAxiosFetch as d}from"@lifeomic/axios-fetch";import g from"axios";import m from"crypto";import{httpsOverHttps as w,httpsOverHttp as y}from"tunnel";import v from"os";import k from"socket.io-client";var b=function(){return(b=Object.assign||function(t){for(var e,n=1,r=arguments.length;n<r;n++)for(var o in e=arguments[n])Object.prototype.hasOwnProperty.call(e,o)&&(t[o]=e[o]);return t}).apply(this,arguments)};function I(t,e,n,r){return new(n||(n=Promise))((function(o,s){function i(t){try{u(r.next(t))}catch(e){s(e)}}function a(t){try{u(r.throw(t))}catch(e){s(e)}}function u(t){var e;t.done?o(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(i,a)}u((r=r.apply(t,e||[])).next())}))}function $(t,e){var n,r,o,s,i={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return s={next:a(0),throw:a(1),return:a(2)},"function"===typeof Symbol&&(s[Symbol.iterator]=function(){return this}),s;function a(s){return function(a){return function(s){if(n)throw new TypeError("Generator is already executing.");for(;i;)try{if(n=1,r&&(o=2&s[0]?r.return:s[0]?r.throw||((o=r.return)&&o.call(r),0):r.next)&&!(o=o.call(r,s[1])).done)return o;switch(r=0,o&&(s=[2&s[0],o.value]),s[0]){case 0:case 1:o=s;break;case 4:return i.label++,{value:s[1],done:!1};case 5:i.label++,r=s[1],s=[0];continue;case 7:s=i.ops.pop(),i.trys.pop();continue;default:if(!(o=(o=i.trys).length>0&&o[o.length-1])&&(6===s[0]||2===s[0])){i=0;continue}if(3===s[0]&&(!o||s[1]>o[0]&&s[1]<o[3])){i.label=s[1];break}if(6===s[0]&&i.label<o[1]){i.label=o[1],o=s;break}if(o&&i.label<o[2]){i.label=o[2],i.ops.push(s);break}o[2]&&i.ops.pop(),i.trys.pop();continue}s=e.call(t,i)}catch(a){s=[6,a],r=0}finally{n=o=0}if(5&s[0])throw s[1];return{value:s[0]?s[1]:void 0,done:!0}}([s,a])}}}function S(){for(var t=0,e=0,n=arguments.length;e<n;e++)t+=arguments[e].length;var r=Array(t),o=0;for(e=0;e<n;e++)for(var s=arguments[e],i=0,a=s.length;i<a;i++,o++)r[o]=s[i];return r}function j(t,e){return Object.defineProperty?Object.defineProperty(t,"raw",{value:e}):t.raw=e,t}var x="https://epi2me.nanoporetech.com",P={local:!1,url:x,user_agent:"EPI2ME API",region:"eu-west-1",sessionGrace:5,uploadTimeout:1200,downloadTimeout:1200,fileCheckInterval:5,downloadCheckInterval:3,stateCheckInterval:60,inFlightDelay:600,waitTimeSeconds:20,waitTokenError:30,transferPoolSize:3,downloadMode:"data+telemetry",filetype:[".fastq",".fq",".fastq.gz",".fq.gz"],signing:!0,sampleDirectory:"/data"},T="\npage\npages\nhasNext\nhasPrevious\ntotalCount\n",E="\nidWorkflowInstance\nstartDate\nworkflowImage{\n  workflow\n  {\n    rev\n    name\n  }\n}\n",A="undefined"!==typeof globalThis?globalThis:"undefined"!==typeof window?window:"undefined"!==typeof global?global:"undefined"!==typeof self?self:{};function _(t,e,n){return t(n={path:e,exports:{},require:function(t,e){return function(){throw new Error("Dynamic requires are not currently supported by @rollup/plugin-commonjs")}((void 0===e||null===e)&&n.path)}},n.exports),n.exports}var W=_((function(t,e){!function(n){var r=e&&!e.nodeType&&e,o=t&&!t.nodeType&&t,s="object"==typeof A&&A;s.global!==s&&s.window!==s&&s.self!==s||(n=s);var i,a,u=2147483647,c=/^xn--/,l=/[^\x20-\x7E]/,h=/[\x2E\u3002\uFF0E\uFF61]/g,p={overflow:"Overflow: input needs wider integers to process","not-basic":"Illegal input >= 0x80 (not a basic code point)","invalid-input":"Invalid input"},f=Math.floor,d=String.fromCharCode;function g(t){throw RangeError(p[t])}function m(t,e){for(var n=t.length,r=[];n--;)r[n]=e(t[n]);return r}function w(t,e){var n=t.split("@"),r="";return n.length>1&&(r=n[0]+"@",t=n[1]),r+m((t=t.replace(h,".")).split("."),e).join(".")}function y(t){for(var e,n,r=[],o=0,s=t.length;o<s;)(e=t.charCodeAt(o++))>=55296&&e<=56319&&o<s?56320==(64512&(n=t.charCodeAt(o++)))?r.push(((1023&e)<<10)+(1023&n)+65536):(r.push(e),o--):r.push(e);return r}function v(t){return m(t,(function(t){var e="";return t>65535&&(e+=d((t-=65536)>>>10&1023|55296),t=56320|1023&t),e+=d(t)})).join("")}function k(t,e){return t+22+75*(t<26)-((0!=e)<<5)}function b(t,e,n){var r=0;for(t=n?f(t/700):t>>1,t+=f(t/e);t>455;r+=36)t=f(t/35);return f(r+36*t/(t+38))}function I(t){var e,n,r,o,s,i,a,c,l,h,p,d=[],m=t.length,w=0,y=128,k=72;for((n=t.lastIndexOf("-"))<0&&(n=0),r=0;r<n;++r)t.charCodeAt(r)>=128&&g("not-basic"),d.push(t.charCodeAt(r));for(o=n>0?n+1:0;o<m;){for(s=w,i=1,a=36;o>=m&&g("invalid-input"),((c=(p=t.charCodeAt(o++))-48<10?p-22:p-65<26?p-65:p-97<26?p-97:36)>=36||c>f((u-w)/i))&&g("overflow"),w+=c*i,!(c<(l=a<=k?1:a>=k+26?26:a-k));a+=36)i>f(u/(h=36-l))&&g("overflow"),i*=h;k=b(w-s,e=d.length+1,0==s),f(w/e)>u-y&&g("overflow"),y+=f(w/e),w%=e,d.splice(w++,0,y)}return v(d)}function $(t){var e,n,r,o,s,i,a,c,l,h,p,m,w,v,I,$=[];for(m=(t=y(t)).length,e=128,n=0,s=72,i=0;i<m;++i)(p=t[i])<128&&$.push(d(p));for(r=o=$.length,o&&$.push("-");r<m;){for(a=u,i=0;i<m;++i)(p=t[i])>=e&&p<a&&(a=p);for(a-e>f((u-n)/(w=r+1))&&g("overflow"),n+=(a-e)*w,e=a,i=0;i<m;++i)if((p=t[i])<e&&++n>u&&g("overflow"),p==e){for(c=n,l=36;!(c<(h=l<=s?1:l>=s+26?26:l-s));l+=36)I=c-h,v=36-h,$.push(d(k(h+I%v,0))),c=f(I/v);$.push(d(k(c,0))),s=b(n,w,r==o),n=0,++r}++n,++e}return $.join("")}if(i={version:"1.3.2",ucs2:{decode:y,encode:v},decode:I,encode:$,toASCII:function(t){return w(t,(function(t){return l.test(t)?"xn--"+$(t):t}))},toUnicode:function(t){return w(t,(function(t){return c.test(t)?I(t.slice(4).toLowerCase()):t}))}},r&&o)if(t.exports==r)o.exports=i;else for(a in i)i.hasOwnProperty(a)&&(r[a]=i[a]);else n.punycode=i}(A)}));function O(t,e){return Object.prototype.hasOwnProperty.call(t,e)}var C=function(t,e,n,r){e=e||"&",n=n||"=";var o={};if("string"!==typeof t||0===t.length)return o;var s=/\+/g;t=t.split(e);var i=1e3;r&&"number"===typeof r.maxKeys&&(i=r.maxKeys);var a=t.length;i>0&&a>i&&(a=i);for(var u=0;u<a;++u){var c,l,h,p,f=t[u].replace(s,"%20"),d=f.indexOf(n);d>=0?(c=f.substr(0,d),l=f.substr(d+1)):(c=f,l=""),h=decodeURIComponent(c),p=decodeURIComponent(l),O(o,h)?Array.isArray(o[h])?o[h].push(p):o[h]=[o[h],p]:o[h]=p}return o},D=function(t){switch(typeof t){case"string":return t;case"boolean":return t?"true":"false";case"number":return isFinite(t)?t:"";default:return""}},q=function(t,e,n,r){return e=e||"&",n=n||"=",null===t&&(t=void 0),"object"===typeof t?Object.keys(t).map((function(r){var o=encodeURIComponent(D(r))+n;return Array.isArray(t[r])?t[r].map((function(t){return o+encodeURIComponent(D(t))})).join(e):o+encodeURIComponent(D(t[r]))})).join(e):r?encodeURIComponent(D(r))+n+encodeURIComponent(D(t)):""},R=_((function(t,e){e.decode=e.parse=C,e.encode=e.stringify=q})),U=function(t,e){return Q(t,!1,!0).resolve(e)};function z(){this.protocol=null,this.slashes=null,this.auth=null,this.host=null,this.port=null,this.hostname=null,this.hash=null,this.search=null,this.query=null,this.pathname=null,this.path=null,this.href=null}var H=/^([a-z0-9.+-]+:)/i,N=/:[0-9]*$/,M=["{","}","|","\\","^","`"].concat(["<",">",'"',"`"," ","\r","\n","\t"]),B=["'"].concat(M),F=["%","/","?",";","#"].concat(B),J=["/","?","#"],G=/^[a-z0-9A-Z_-]{0,63}$/,K=/^([a-z0-9A-Z_-]{0,63})(.*)$/,X={javascript:!0,"javascript:":!0},L={javascript:!0,"javascript:":!0},V={http:!0,https:!0,ftp:!0,gopher:!0,file:!0,"http:":!0,"https:":!0,"ftp:":!0,"gopher:":!0,"file:":!0};function Q(t,e,n){if(t&&Y(t)&&t instanceof z)return t;var r=new z;return r.parse(t,e,n),r}function Z(t){return"string"===typeof t}function Y(t){return"object"===typeof t&&null!==t}function tt(t){return null===t}z.prototype.parse=function(t,e,n){if(!Z(t))throw new TypeError("Parameter 'url' must be a string, not "+typeof t);var r=t;r=r.trim();var o=H.exec(r);if(o){var s=(o=o[0]).toLowerCase();this.protocol=s,r=r.substr(o.length)}if(n||o||r.match(/^\/\/[^@\/]+@[^@\/]+/)){var i="//"===r.substr(0,2);!i||o&&L[o]||(r=r.substr(2),this.slashes=!0)}if(!L[o]&&(i||o&&!V[o])){for(var a,u,c=-1,l=0;l<J.length;l++){-1!==(h=r.indexOf(J[l]))&&(-1===c||h<c)&&(c=h)}-1!==(u=-1===c?r.lastIndexOf("@"):r.lastIndexOf("@",c))&&(a=r.slice(0,u),r=r.slice(u+1),this.auth=decodeURIComponent(a)),c=-1;for(l=0;l<F.length;l++){var h;-1!==(h=r.indexOf(F[l]))&&(-1===c||h<c)&&(c=h)}-1===c&&(c=r.length),this.host=r.slice(0,c),r=r.slice(c),this.parseHost(),this.hostname=this.hostname||"";var p="["===this.hostname[0]&&"]"===this.hostname[this.hostname.length-1];if(!p)for(var f=this.hostname.split(/\./),d=(l=0,f.length);l<d;l++){var g=f[l];if(g&&!g.match(G)){for(var m="",w=0,y=g.length;w<y;w++)g.charCodeAt(w)>127?m+="x":m+=g[w];if(!m.match(G)){var v=f.slice(0,l),k=f.slice(l+1),b=g.match(K);b&&(v.push(b[1]),k.unshift(b[2])),k.length&&(r="/"+k.join(".")+r),this.hostname=v.join(".");break}}}if(this.hostname.length>255?this.hostname="":this.hostname=this.hostname.toLowerCase(),!p){var I=this.hostname.split("."),$=[];for(l=0;l<I.length;++l){var S=I[l];$.push(S.match(/[^A-Za-z0-9_-]/)?"xn--"+W.encode(S):S)}this.hostname=$.join(".")}var j=this.port?":"+this.port:"",x=this.hostname||"";this.host=x+j,this.href+=this.host,p&&(this.hostname=this.hostname.substr(1,this.hostname.length-2),"/"!==r[0]&&(r="/"+r))}if(!X[s])for(l=0,d=B.length;l<d;l++){var P=B[l],T=encodeURIComponent(P);T===P&&(T=escape(P)),r=r.split(P).join(T)}var E=r.indexOf("#");-1!==E&&(this.hash=r.substr(E),r=r.slice(0,E));var A=r.indexOf("?");if(-1!==A?(this.search=r.substr(A),this.query=r.substr(A+1),e&&(this.query=R.parse(this.query)),r=r.slice(0,A)):e&&(this.search="",this.query={}),r&&(this.pathname=r),V[s]&&this.hostname&&!this.pathname&&(this.pathname="/"),this.pathname||this.search){j=this.pathname||"",S=this.search||"";this.path=j+S}return this.href=this.format(),this},z.prototype.format=function(){var t=this.auth||"";t&&(t=(t=encodeURIComponent(t)).replace(/%3A/i,":"),t+="@");var e=this.protocol||"",n=this.pathname||"",r=this.hash||"",o=!1,s="";this.host?o=t+this.host:this.hostname&&(o=t+(-1===this.hostname.indexOf(":")?this.hostname:"["+this.hostname+"]"),this.port&&(o+=":"+this.port)),this.query&&Y(this.query)&&Object.keys(this.query).length&&(s=R.stringify(this.query));var i=this.search||s&&"?"+s||"";return e&&":"!==e.substr(-1)&&(e+=":"),this.slashes||(!e||V[e])&&!1!==o?(o="//"+(o||""),n&&"/"!==n.charAt(0)&&(n="/"+n)):o||(o=""),r&&"#"!==r.charAt(0)&&(r="#"+r),i&&"?"!==i.charAt(0)&&(i="?"+i),e+o+(n=n.replace(/[?#]/g,(function(t){return encodeURIComponent(t)})))+(i=i.replace("#","%23"))+r},z.prototype.resolve=function(t){return this.resolveObject(Q(t,!1,!0)).format()},z.prototype.resolveObject=function(t){if(Z(t)){var e=new z;e.parse(t,!1,!0),t=e}var n=new z;if(Object.keys(this).forEach((function(t){n[t]=this[t]}),this),n.hash=t.hash,""===t.href)return n.href=n.format(),n;if(t.slashes&&!t.protocol)return Object.keys(t).forEach((function(e){"protocol"!==e&&(n[e]=t[e])})),V[n.protocol]&&n.hostname&&!n.pathname&&(n.path=n.pathname="/"),n.href=n.format(),n;if(t.protocol&&t.protocol!==n.protocol){if(!V[t.protocol])return Object.keys(t).forEach((function(e){n[e]=t[e]})),n.href=n.format(),n;if(n.protocol=t.protocol,t.host||L[t.protocol])n.pathname=t.pathname;else{for(var r=(t.pathname||"").split("/");r.length&&!(t.host=r.shift()););t.host||(t.host=""),t.hostname||(t.hostname=""),""!==r[0]&&r.unshift(""),r.length<2&&r.unshift(""),n.pathname=r.join("/")}if(n.search=t.search,n.query=t.query,n.host=t.host||"",n.auth=t.auth,n.hostname=t.hostname||t.host,n.port=t.port,n.pathname||n.search){var o=n.pathname||"",s=n.search||"";n.path=o+s}return n.slashes=n.slashes||t.slashes,n.href=n.format(),n}var i=n.pathname&&"/"===n.pathname.charAt(0),a=t.host||t.pathname&&"/"===t.pathname.charAt(0),u=a||i||n.host&&t.pathname,c=u,l=n.pathname&&n.pathname.split("/")||[],h=(r=t.pathname&&t.pathname.split("/")||[],n.protocol&&!V[n.protocol]);if(h&&(n.hostname="",n.port=null,n.host&&(""===l[0]?l[0]=n.host:l.unshift(n.host)),n.host="",t.protocol&&(t.hostname=null,t.port=null,t.host&&(""===r[0]?r[0]=t.host:r.unshift(t.host)),t.host=null),u=u&&(""===r[0]||""===l[0])),a)n.host=t.host||""===t.host?t.host:n.host,n.hostname=t.hostname||""===t.hostname?t.hostname:n.hostname,n.search=t.search,n.query=t.query,l=r;else if(r.length)l||(l=[]),l.pop(),l=l.concat(r),n.search=t.search,n.query=t.query;else if(null!=t.search){if(h)n.hostname=n.host=l.shift(),(m=!!(n.host&&n.host.indexOf("@")>0)&&n.host.split("@"))&&(n.auth=m.shift(),n.host=n.hostname=m.shift());return n.search=t.search,n.query=t.query,tt(n.pathname)&&tt(n.search)||(n.path=(n.pathname?n.pathname:"")+(n.search?n.search:"")),n.href=n.format(),n}if(!l.length)return n.pathname=null,n.search?n.path="/"+n.search:n.path=null,n.href=n.format(),n;for(var p=l.slice(-1)[0],f=(n.host||t.host)&&("."===p||".."===p)||""===p,d=0,g=l.length;g>=0;g--)"."==(p=l[g])?l.splice(g,1):".."===p?(l.splice(g,1),d++):d&&(l.splice(g,1),d--);if(!u&&!c)for(;d--;d)l.unshift("..");!u||""===l[0]||l[0]&&"/"===l[0].charAt(0)||l.unshift(""),f&&"/"!==l.join("/").substr(-1)&&l.push("");var m,w=""===l[0]||l[0]&&"/"===l[0].charAt(0);h&&(n.hostname=n.host=w?"":l.length?l.shift():"",(m=!!(n.host&&n.host.indexOf("@")>0)&&n.host.split("@"))&&(n.auth=m.shift(),n.host=n.hostname=m.shift()));return(u=u||n.host&&l.length)&&!w&&l.unshift(""),l.length?n.pathname=l.join("/"):(n.pathname=null,n.path=null),tt(n.pathname)&&tt(n.search)||(n.path=(n.pathname?n.pathname:"")+(n.search?n.search:"")),n.auth=t.auth||n.auth,n.slashes=n.slashes||t.slashes,n.href=n.format(),n},z.prototype.parseHost=function(){var t=this.host,e=N.exec(t);e&&(":"!==(e=e[0])&&(this.port=e.substr(1)),t=t.substr(0,t.length-e.length)),t&&(this.hostname=t)};var et=function(){var e=function(t,e){t.headers||(t.headers={});var n=e;if(n||(n={}),n.apikey&&n.apisecret){t.headers["X-EPI2ME-APIKEY"]=n.apikey,t.headers["X-EPI2ME-SIGNATUREDATE"]=(new Date).toISOString();var r=[Object.keys(t.headers).sort().filter((function(t){return t.match(/^x-epi2me/i)})).map((function(e){return e+":"+t.headers[e]})).join("\n"),t.body].join("\n"),o=m.createHmac("sha1",n.apisecret).update(r).digest("hex");t.headers["X-EPI2ME-SIGNATUREV0"]=o}};return{version:"3.0.1759",setHeaders:function(n,r){var o=t({log:{debug:function(){}}},r).log,s=r;if(s||(s={}),n.headers=t({Accept:"application/json","Content-Type":"application/json","X-EPI2ME-CLIENT":s.user_agent||"api","X-EPI2ME-VERSION":s.agent_version||et.version},n.headers,s.headers),"signing"in s&&!s.signing||e(n,s),s.proxy){var i=s.proxy.match(/https?:\/\/((\S+):(\S+)@)?(\S+):(\d+)/),a=i[2],u=i[3],c={host:i[4],port:i[5]};a&&u&&(c.proxyAuth=a+":"+u),s.proxy.match(/^https/)?(o.debug("using HTTPS over HTTPS proxy",JSON.stringify(c)),n.httpsAgent=w({proxy:c})):(o.debug("using HTTPS over HTTP proxy",JSON.stringify(c)),n.httpsAgent=y({proxy:c})),n.proxy=!1}}}}(),nt=d(g),rt=function(t,e){var n=e.headers.keys,r=n.apikey,o=n.apisecret;return delete e.headers.keys,et.setHeaders(e,{apikey:r,apisecret:o,signing:!0}),nt(t,e)},ot=new l({link:new h((function(t){var e=t.getContext(),n=e.apikey,r=e.apisecret,o=e.url,s=f({uri:U(o,"/graphql"),fetch:rt,headers:{keys:{apikey:n,apisecret:r}}});return p(s,t)})),cache:new c});g.defaults.validateStatus=function(t){return t<=504};var st,it,at,ut,ct,lt,ht,pt,ft,dt,gt,mt,wt,yt,vt,kt=function(){var e=this,n=function(t,e){t.headers||(t.headers={});var n=e;if(n||(n={}),n.apikey&&(t.headers["X-EPI2ME-ApiKey"]=n.apikey,n.apisecret)){t.headers["X-EPI2ME-SignatureDate"]=(new Date).toISOString(),t.url.match(/^https:/)&&(t.url=t.url.replace(/:443/,"")),t.url.match(/^http:/)&&(t.url=t.url.replace(/:80/,""));var r=[t.url,Object.keys(t.headers).sort().filter((function(t){return t.match(/^x-epi2me/i)})).map((function(e){return e+":"+t.headers[e]})).join("\n")].join("\n"),o=m.createHmac("sha1",n.apisecret).update(r).digest("hex");t.headers["X-EPI2ME-SignatureV0"]=o}},r=function(t){return I(e,void 0,void 0,(function(){var e,n;return $(this,(function(r){return(e=t?t.data:null)?t&&t.status>=400?(n="Network error "+t.status,e.error&&(n=e.error),504===t.status&&(n="Please check your network connection and try again."),[2,Promise.reject(new Error(n))]):e.error?[2,Promise.reject(new Error(e.error))]:[2,Promise.resolve(e)]:[2,Promise.reject(new Error("unexpected non-json response"))]}))}))};return{version:"3.0.1759",headers:function(e,r){var o=t({log:{debug:function(){}}},r).log,s=r;if(s||(s={}),e.headers=t({Accept:"application/json","Content-Type":"application/json","X-EPI2ME-Client":s.user_agent||"api","X-EPI2ME-Version":s.agent_version||kt.version},e.headers,s.headers),"signing"in s&&!s.signing||n(e,s),s.proxy){var i=s.proxy.match(/https?:\/\/((\S+):(\S+)@)?(\S+):(\d+)/),a=i[2],u=i[3],c={host:i[4],port:i[5]};a&&u&&(c.proxyAuth=a+":"+u),s.proxy.match(/^https/)?(o.debug("using HTTPS over HTTPS proxy",JSON.stringify(c)),e.httpsAgent=w({proxy:c})):(o.debug("using HTTPS over HTTP proxy",JSON.stringify(c)),e.httpsAgent=y({proxy:c})),e.proxy=!1}},head:function(n,r){return I(e,void 0,void 0,(function(){var e,o,s,i,a,u,c,l;return $(this,(function(h){switch(h.label){case 0:e=t({log:{debug:function(){}}},r).log,s=r.url,i=n,r.skip_url_mangle?o=i:(i="/"+i,s=s.replace(/\/+$/,""),i=i.replace(/\/+/g,"/"),o=s+i),a={url:o,gzip:!0},kt.headers(a,r),h.label=1;case 1:return h.trys.push([1,3,,4]),e.debug("HEAD "+a.url),[4,g.head(a.url,a)];case 2:return(u=h.sent())&&u.status>=400?(c="Network error "+u.status,504===u.status&&(c="Please check your network connection and try again."),[2,Promise.reject(new Error(c))]):[3,4];case 3:return l=h.sent(),[2,Promise.reject(l)];case 4:return[2,Promise.resolve(u)]}}))}))},get:function(n,o){return I(e,void 0,void 0,(function(){var e,s,i,a,u,c,l;return $(this,(function(h){switch(h.label){case 0:e=t({log:{debug:function(){}}},o).log,i=o.url,a=n,o.skip_url_mangle?s=a:(a="/"+a,i=i.replace(/\/+$/,""),a=a.replace(/\/+/g,"/"),s=i+a),u={url:s,gzip:!0},kt.headers(u,o),h.label=1;case 1:return h.trys.push([1,3,,4]),e.debug("GET "+u.url),[4,g.get(u.url,u)];case 2:return c=h.sent(),[3,4];case 3:return l=h.sent(),[2,Promise.reject(l)];case 4:return[2,r(c,o)]}}))}))},post:function(n,o,s){return I(e,void 0,void 0,(function(){var e,i,a,u,c,l,h,p,f;return $(this,(function(d){switch(d.label){case 0:e=t({log:{debug:function(){}}},s).log,i=(i=s.url).replace(/\/+$/,""),a=n.replace(/\/+/g,"/"),u={url:i+"/"+a,gzip:!0,data:o,headers:{}},s.legacy_form&&(c=[],l=t({json:JSON.stringify(o)},o),Object.keys(l).sort().forEach((function(t){c.push(t+"="+escape(l[t]))})),u.data=c.join("&"),u.headers["Content-Type"]="application/x-www-form-urlencoded"),kt.headers(u,s),h=u.data,delete u.data,d.label=1;case 1:return d.trys.push([1,3,,4]),e.debug("POST "+u.url),[4,g.post(u.url,h,u)];case 2:return p=d.sent(),[3,4];case 3:return f=d.sent(),[2,Promise.reject(f)];case 4:return s.handler?[2,s.handler(p)]:[2,r(p,s)]}}))}))},put:function(n,o,s,i){return I(e,void 0,void 0,(function(){var e,a,u,c,l,h,p,f,d;return $(this,(function(m){switch(m.label){case 0:e=t({log:{debug:function(){}}},i).log,a=(a=i.url).replace(/\/+$/,""),u=n.replace(/\/+/g,"/"),c={url:a+"/"+u+"/"+o,gzip:!0,data:s,headers:{}},i.legacy_form&&(l=[],h=t({json:JSON.stringify(s)},s),Object.keys(h).sort().forEach((function(t){l.push(t+"="+escape(h[t]))})),c.data=l.join("&"),c.headers["Content-Type"]="application/x-www-form-urlencoded"),kt.headers(c,i),p=c.data,delete c.data,m.label=1;case 1:return m.trys.push([1,3,,4]),e.debug("PUT "+c.url),[4,g.put(c.url,p,c)];case 2:return f=m.sent(),[3,4];case 3:return d=m.sent(),[2,Promise.reject(d)];case 4:return[2,r(f,i)]}}))}))},convertResponseToObject:function(t){if("object"===typeof t)return t;try{return JSON.parse(t)}catch(e){throw new Error("exception parsing chain JSON "+String(e))}}}}(),bt=function(n){var r=this;this.createContext=function(e){var n=r.options,o=n.apikey,s=n.apisecret,i=n.url;return t({apikey:o,apisecret:s,url:i},e)},this.query=function(t){return function(e){var n,o=void 0===e?{}:e,s=o.context,i=void 0===s?{}:s,a=o.variables,c=void 0===a?{}:a,l=o.options,h=void 0===l?{}:l,p=r.createContext(i);return n="string"===typeof t?u(st||(st=j(["\n        ","\n      "],["\n        ","\n      "])),t):"function"===typeof t?u(it||(it=j(["\n        ","\n      "],["\n        ","\n      "])),t(T)):t,r.client.query(b(b({query:n,variables:c},h),{context:p}))}},this.mutate=function(t){return function(e){var n,o=void 0===e?{}:e,s=o.context,i=void 0===s?{}:s,a=o.variables,c=void 0===a?{}:a,l=o.options,h=void 0===l?{}:l,p=r.createContext(i);return n="string"===typeof t?u(at||(at=j(["\n        ","\n      "],["\n        ","\n      "])),t):t,r.client.mutate(b(b({mutation:n,variables:c},h),{context:p}))}},this.resetCache=function(){r.client.resetStore()},this.workflows=this.query(u(ut||(ut=j(["\n    query allWorkflows($page: Int, $pageSize: Int, $isActive: Int, $orderBy: String, $region: String) {\n      allWorkflows(page: $page, pageSize: $pageSize, isActive: $isActive, orderBy: $orderBy, region: $region) {\n        ","\n        results {\n          ","\n        }\n      }\n    }\n  "],["\n    query allWorkflows($page: Int, $pageSize: Int, $isActive: Int, $orderBy: String, $region: String) {\n      allWorkflows(page: $page, pageSize: $pageSize, isActive: $isActive, orderBy: $orderBy, region: $region) {\n        ","\n        results {\n          ","\n        }\n      }\n    }\n  "])),T,"\nidWorkflow\nname\ndescription\nsummary\nrev\n")),this.workflowPages=function(t){return I(r,void 0,void 0,(function(){var e,n,r,o=this;return $(this,(function(s){switch(s.label){case 0:return e=t,[4,this.workflows({variables:{page:e}})];case 1:return n=s.sent(),r=function(t){return I(o,void 0,void 0,(function(){return $(this,(function(r){switch(r.label){case 0:return e=t,[4,this.workflows({variables:{page:e}})];case 1:return[2,n=r.sent()]}}))}))},[2,{data:n,next:function(){return r(e+1)},previous:function(){return r(e-1)},first:function(){return r(1)},last:function(){return r(0)}}]}}))}))},this.workflow=this.query(u(ct||(ct=j(["\n    query workflow($idWorkflow: ID!) {\n      workflow(idWorkflow: $idWorkflow) {\n        ","\n      }\n    }\n   "],["\n    query workflow($idWorkflow: ID!) {\n      workflow(idWorkflow: $idWorkflow) {\n        ","\n      }\n    }\n   "])),"\nidWorkflow\nname\ndescription\nsummary\nrev\n")),this.workflowInstances=this.query(u(lt||(lt=j(["\n  query allWorkflowInstances($page: Int, $pageSize: Int, $shared: Boolean, $idUser: ID, $orderBy: String) {\n    allWorkflowInstances(page: $page, pageSize: $pageSize, shared: $shared, idUser: $idUser, orderBy: $orderBy) {\n      ","\n      results {\n        ","\n      }\n    }\n  }\n   "],["\n  query allWorkflowInstances($page: Int, $pageSize: Int, $shared: Boolean, $idUser: ID, $orderBy: String) {\n    allWorkflowInstances(page: $page, pageSize: $pageSize, shared: $shared, idUser: $idUser, orderBy: $orderBy) {\n      ","\n      results {\n        ","\n      }\n    }\n  }\n   "])),T,E)),this.workflowInstance=this.query(u(ht||(ht=j(["\n      query workflowInstance($idWorkflowInstance: ID!) {\n        workflowInstance(idWorkflowInstance: $idWorkflowInstance) {\n          ","\n        }\n      }\n   "],["\n      query workflowInstance($idWorkflowInstance: ID!) {\n        workflowInstance(idWorkflowInstance: $idWorkflowInstance) {\n          ","\n        }\n      }\n   "])),E)),this.startWorkflow=this.mutate(u(pt||(pt=j(["\n    mutation startWorkflow(\n      $idWorkflow: ID!\n      $computeAccountId: ID!\n      $storageAccountId: ID\n      $isConsentedHuman: Boolean = false\n      $idDataset: ID\n      $storeResults: Boolean = false\n      $userDefined: GenericScalar\n      $instanceAttributes: [GenericScalar]\n      $region: String\n    ) {\n      startData: startWorkflowInstance(\n        idWorkflow: $idWorkflow\n        computeAccountId: $computeAccountId\n        storageAccountId: $storageAccountId\n        isConsentedHuman: $isConsentedHuman\n        idDataset: $idDataset\n        storeResults: $storeResults\n        userDefined: $userDefined\n        instanceAttributes: $instanceAttributes\n        region: $region\n      ) {\n        bucket\n        idUser\n        remoteAddr\n        instance {\n          idWorkflowInstance\n          chain\n          keyId\n          outputqueue\n          mappedTelemetry\n          workflowImage {\n            inputqueue\n            workflow {\n              idWorkflow\n            }\n            region {\n              name\n            }\n          }\n        }\n      }\n    }\n  "],["\n    mutation startWorkflow(\n      $idWorkflow: ID!\n      $computeAccountId: ID!\n      $storageAccountId: ID\n      $isConsentedHuman: Boolean = false\n      $idDataset: ID\n      $storeResults: Boolean = false\n      $userDefined: GenericScalar\n      $instanceAttributes: [GenericScalar]\n      $region: String\n    ) {\n      startData: startWorkflowInstance(\n        idWorkflow: $idWorkflow\n        computeAccountId: $computeAccountId\n        storageAccountId: $storageAccountId\n        isConsentedHuman: $isConsentedHuman\n        idDataset: $idDataset\n        storeResults: $storeResults\n        userDefined: $userDefined\n        instanceAttributes: $instanceAttributes\n        region: $region\n      ) {\n        bucket\n        idUser\n        remoteAddr\n        instance {\n          idWorkflowInstance\n          chain\n          keyId\n          outputqueue\n          mappedTelemetry\n          workflowImage {\n            inputqueue\n            workflow {\n              idWorkflow\n            }\n            region {\n              name\n            }\n          }\n        }\n      }\n    }\n  "])))),this.stopWorkflow=this.mutate(u(ft||(ft=j(["\n    mutation stopWorkflowInstance($idWorkflowInstance: ID!) {\n      stopData: stopWorkflowInstance(idWorkflowInstance: $idWorkflowInstance) {\n        success\n        message\n      }\n    }\n  "],["\n    mutation stopWorkflowInstance($idWorkflowInstance: ID!) {\n      stopData: stopWorkflowInstance(idWorkflowInstance: $idWorkflowInstance) {\n        success\n        message\n      }\n    }\n  "])))),this.instanceToken=this.mutate(u(dt||(dt=j(["\n    mutation getInstanceToken($idWorkflowInstance: ID!) {\n      token: getInstanceToken(idWorkflowInstance: $idWorkflowInstance) {\n        id_workflow_instance: idWorkflowInstance\n        accessKeyId\n        secretAccessKey\n        sessionToken\n        expiration\n        region\n      }\n    }\n  "],["\n    mutation getInstanceToken($idWorkflowInstance: ID!) {\n      token: getInstanceToken(idWorkflowInstance: $idWorkflowInstance) {\n        id_workflow_instance: idWorkflowInstance\n        accessKeyId\n        secretAccessKey\n        sessionToken\n        expiration\n        region\n      }\n    }\n  "])))),this.user=this.query(u(gt||(gt=j(["\n    query user {\n      me {\n        username\n        realname\n        useraccountSet {\n          idUserAccount\n        }\n      }\n    }\n  "],["\n    query user {\n      me {\n        username\n        realname\n        useraccountSet {\n          idUserAccount\n        }\n      }\n    }\n  "])))),this.updateUser=this.mutate(u(mt||(mt=j(["\n    mutation updateUser($idRegionPreferred: ID!) {\n      updateUser(idRegionPreferred: $idRegionPreferred) {\n        idRegionPreferred\n      }\n    }\n  "],["\n    mutation updateUser($idRegionPreferred: ID!) {\n      updateUser(idRegionPreferred: $idRegionPreferred) {\n        idRegionPreferred\n      }\n    }\n  "])))),this.register=this.mutate(u(wt||(wt=j(["\n    mutation registerToken($code: String!, $description: String) {\n      registerToken(code: $code, description: $description) {\n        apikey\n        apisecret\n        description\n      }\n    }\n  "],["\n    mutation registerToken($code: String!, $description: String) {\n      registerToken(code: $code, description: $description) {\n        apikey\n        apisecret\n        description\n      }\n    }\n  "])))),this.status=this.query(u(yt||(yt=j(["\n    query status {\n      status {\n        portalVersion\n        remoteAddr\n        serverTime\n        minimumAgent\n        dbVersion\n      }\n    }\n  "],["\n    query status {\n      status {\n        portalVersion\n        remoteAddr\n        serverTime\n        minimumAgent\n        dbVersion\n      }\n    }\n  "])))),this.healthCheck=function(){return kt.get("/status",b(b({},r.options),{log:{debug:function(){}}}))},this.regions=this.query(u(vt||(vt=j(["\n    query regions {\n      regions {\n        idRegion\n        description\n        name\n      }\n    }\n  "],["\n    query regions {\n      regions {\n        idRegion\n        description\n        name\n      }\n    }\n  "])))),this.options=e({agent_version:kt.version,local:!1,url:x,user_agent:"EPI2ME API",signing:!0},n),this.options.url=this.options.url.replace(/:\/\//,"://graphql."),this.options.url=this.options.url.replace(/\/$/,""),this.log=this.options.log,this.client=ot},It=function(t,e){var n=["","K","M","G","T","P","E","Z"],r=e||0,o=t||0;return o>=1e3?(o/=1e3,(r+=1)>=n.length?"???":It(o,r)):0===r?""+o+n[r]:""+o.toFixed(1)+n[r]},$t=function(){function e(e){this.allProfileData={},this.defaultEndpoint=process.env.METRICHOR||P.url,e&&(this.allProfileData=t({profiles:{}},e)),this.allProfileData.endpoint&&(this.defaultEndpoint=this.allProfileData.endpoint)}return e.prototype.profile=function(e){return e?t({endpoint:this.defaultEndpoint},t({profiles:{}},this.allProfileData).profiles[e]):{}},e.prototype.profiles=function(){return Object.keys(this.allProfileData.profiles||{})},e}(),St=function(){function r(t){this.options=e({agent_version:kt.version,local:!1,url:x,user_agent:"EPI2ME API",signing:!0},t),this.log=this.options.log,this.cachedResponses={}}return r.prototype.list=function(t){return I(this,void 0,void 0,(function(){var e;return $(this,(function(n){return e=t.match(/^[a-z_]+/i)[0],[2,kt.get(t,this.options).then((function(t){return t[e+"s"]}))]}))}))},r.prototype.read=function(t,e){return I(this,void 0,void 0,(function(){return $(this,(function(n){return[2,kt.get(t+"/"+e,this.options)]}))}))},r.prototype.user=function(){return I(this,void 0,void 0,(function(){return $(this,(function(t){return this.options.local?[2,{accounts:[{id_user_account:"none",number:"NONE",name:"None"}]}]:[2,kt.get("user",this.options)]}))}))},r.prototype.status=function(){return I(this,void 0,void 0,(function(){return $(this,(function(t){return[2,kt.get("status",this.options)]}))}))},r.prototype.jwt=function(){return I(this,void 0,void 0,(function(){var e;return $(this,(function(n){return e=function(t){return t.headers["x-epi2me-jwt"]?Promise.resolve(t.headers["x-epi2me-jwt"]):Promise.reject(new Error("failed to fetch JWT"))},[2,kt.post("authenticate",{},t({handler:e},this.options))]}))}))},r.prototype.instanceToken=function(n,r){return I(this,void 0,void 0,(function(){return $(this,(function(o){return[2,kt.post("token",t(r,{id_workflow_instance:n}),e({},this.options,{legacy_form:!0}))]}))}))},r.prototype.installToken=function(t){return I(this,void 0,void 0,(function(){return $(this,(function(n){return[2,kt.post("token/install",{id_workflow:t},e({},this.options,{legacy_form:!0}))]}))}))},r.prototype.attributes=function(){return I(this,void 0,void 0,(function(){return $(this,(function(t){return[2,this.list("attribute")]}))}))},r.prototype.workflows=function(){return I(this,void 0,void 0,(function(){return $(this,(function(t){return[2,this.list("workflow")]}))}))},r.prototype.amiImages=function(){return I(this,void 0,void 0,(function(){return $(this,(function(t){if(this.options.local)throw new Error("amiImages unsupported in local mode");return[2,this.list("ami_image")]}))}))},r.prototype.amiImage=function(t,e){return I(this,void 0,void 0,(function(){var n,r,o;return $(this,(function(s){if(t&&e instanceof Object?(n=t,r=e,o="update"):t instanceof Object&&!e?(r=t,o="create"):(o="read",n=t),this.options.local)throw new Error("ami_image unsupported in local mode");if("update"===o)return[2,kt.put("ami_image",n,r,this.options)];if("create"===o)return[2,kt.post("ami_image",r,this.options)];if(!n)throw new Error("no id_ami_image specified");return[2,this.read("ami_image",n)]}))}))},r.prototype.workflow=function(e,r,o){return I(this,void 0,void 0,(function(){var s,i,a,u,c,l,h,p,f,d,g,m,w,y,v,k,b,I=this;return $(this,(function($){switch($.label){case 0:if(e&&r&&o instanceof Function?(s=e,i=r,a=o,u="update"):e&&r instanceof Object&&!(r instanceof Function)?(s=e,i=r,u="update"):e instanceof Object&&r instanceof Function?(i=e,a=r,u="create"):e instanceof Object&&!r?(i=e,u="create"):(u="read",s=e,a=r instanceof Function?r:null),"update"!==u)return[3,4];$.label=1;case 1:return $.trys.push([1,3,,4]),[4,kt.put("workflow",s,i,this.options)];case 2:return c=$.sent(),[2,a?a(null,c):Promise.resolve(c)];case 3:return l=$.sent(),[2,a?a(l):Promise.reject(l)];case 4:if("create"!==u)return[3,8];$.label=5;case 5:return $.trys.push([5,7,,8]),[4,kt.post("workflow",i,this.options)];case 6:return h=$.sent(),[2,a?a(null,h):Promise.resolve(h)];case 7:return p=$.sent(),[2,a?a(p):Promise.reject(p)];case 8:if(!s)return f=new Error("no workflow id specified"),[2,a?a(f):Promise.reject(f)];d={},$.label=9;case 9:return $.trys.push([9,11,,12]),[4,this.read("workflow",s)];case 10:if((g=$.sent()).error)throw new Error(g.error);return t(d,g),[3,12];case 11:return m=$.sent(),this.log.error(s+": error fetching workflow "+String(m)),[2,a?a(m):Promise.reject(m)];case 12:t(d,{params:{}}),$.label=13;case 13:return $.trys.push([13,15,,16]),[4,kt.get("workflow/config/"+s,this.options)];case 14:if((w=$.sent()).error)throw new Error(w.error);return t(d,w),[3,16];case 15:return y=$.sent(),this.log.error(s+": error fetching workflow config "+String(y)),[2,a?a(y):Promise.reject(y)];case 16:v=n(d.params,{widget:"ajax_dropdown"}),k=S(v.map((function(t,e){var n=v[e];return new Promise((function(t,e){var r=n.values.source.replace("{{EPI2ME_HOST}}","").replace(/&?apikey=\{\{EPI2ME_API_KEY\}\}/,"");kt.get(r,I.options).then((function(e){var r=e[n.values.data_root];return r&&(n.values=r.map((function(t){return{label:t[n.values.items.label_key],value:t[n.values.items.value_key]}}))),t()})).catch((function(t){return I.log.error("failed to fetch "+r),e(t)}))}))}))),$.label=17;case 17:return $.trys.push([17,19,,20]),[4,Promise.all(k)];case 18:return $.sent(),[2,a?a(null,d):Promise.resolve(d)];case 19:return b=$.sent(),this.log.error(s+": error fetching config and parameters "+String(b)),[2,a?a(b):Promise.reject(b)];case 20:return[2]}}))}))},r.prototype.startWorkflow=function(t){return I(this,void 0,void 0,(function(){return $(this,(function(n){return[2,kt.post("workflow_instance",t,e({},this.options,{legacy_form:!0}))]}))}))},r.prototype.stopWorkflow=function(t){return I(this,void 0,void 0,(function(){return $(this,(function(n){return[2,kt.put("workflow_instance/stop",t,null,e({},this.options,{legacy_form:!0}))]}))}))},r.prototype.workflowInstances=function(t){return I(this,void 0,void 0,(function(){return $(this,(function(e){return t&&t.run_id?[2,kt.get("workflow_instance/wi?show=all&columns[0][name]=run_id;columns[0][searchable]=true;columns[0][search][regex]=true;columns[0][search][value]="+t.run_id+";",this.options).then((function(t){return t.data.map((function(t){return{id_workflow_instance:t.id_ins,id_workflow:t.id_flo,run_id:t.run_id,description:t.desc,rev:t.rev}}))}))]:[2,this.list("workflow_instance")]}))}))},r.prototype.workflowInstance=function(t){return I(this,void 0,void 0,(function(){return $(this,(function(e){return[2,this.read("workflow_instance",t)]}))}))},r.prototype.workflowConfig=function(t){return I(this,void 0,void 0,(function(){return $(this,(function(e){return[2,kt.get("workflow/config/"+t,this.options)]}))}))},r.prototype.register=function(t,n){return I(this,void 0,void 0,(function(){return $(this,(function(r){return[2,kt.put("reg",t,{description:n||v.userInfo().username+"@"+v.hostname()},e({},this.options,{signing:!1}))]}))}))},r.prototype.datasets=function(t){return I(this,void 0,void 0,(function(){var e;return $(this,(function(n){return(e=t)||(e={}),e.show||(e.show="mine"),[2,this.list("dataset?show="+e.show)]}))}))},r.prototype.dataset=function(t){return I(this,void 0,void 0,(function(){return $(this,(function(e){return this.options.local?[2,this.datasets().then((function(e){return e.find((function(e){return e.id_dataset===t}))}))]:[2,this.read("dataset",t)]}))}))},r.prototype.fetchContent=function(t){return I(this,void 0,void 0,(function(){var n,r,o,s,i;return $(this,(function(a){switch(a.label){case 0:n=e({},this.options,{skip_url_mangle:!0,headers:{"Content-Type":""}}),a.label=1;case 1:return a.trys.push([1,3,,4]),[4,kt.head(t,n)];case 2:return o=a.sent(),(r=o.headers.etag)&&this.cachedResponses[t]&&this.cachedResponses[t].etag===r?[2,this.cachedResponses[t].response]:[3,4];case 3:return s=a.sent(),this.log.warn("Failed to HEAD request "+t+": "+String(s)),[3,4];case 4:return[4,kt.get(t,n)];case 5:return i=a.sent(),r&&(this.cachedResponses[t]={etag:r,response:i}),[2,i]}}))}))},r}(),jt=function(){function e(e,n){var r=this;this.debounces={},this.debounceWindow=t({debounceWindow:2e3},n).debounceWindow,this.log=t({log:{debug:function(){}}},n).log,e.jwt().then((function(t){r.socket=k(n.url,{transportOptions:{polling:{extraHeaders:{Cookie:"x-epi2me-jwt="+t}}}}),r.socket.on("connect",(function(){r.log.debug("socket ready")}))})).catch((function(t){r.log.error("socket connection failed - JWT authentication error")}))}return e.prototype.debounce=function(e,n){var r=this,o=t(e)._uuid;if(o){if(this.debounces[o])return;this.debounces[o]=1,setTimeout((function(){delete r.debounces[o]}),this.debounceWindow)}n&&n(e)},e.prototype.watch=function(t,e){var n=this;if(!this.socket)return this.log.debug("socket not ready. requeueing watch on "+t),void setTimeout((function(){n.watch(t,e)}),1e3);this.socket.on(t,(function(t){return n.debounce(t,e)}))},e.prototype.emit=function(t,e){var n=this;if(!this.socket)return this.log.debug("socket not ready. requeueing emit on "+t),void setTimeout((function(){n.emit(t,e)}),1e3);this.log.debug("socket emit "+t+" "+JSON.stringify(e)),this.socket.emit(t,e)},e}(),xt=function(){function e(e){var n;if((n="string"===typeof e||"object"===typeof e&&e.constructor===String?JSON.parse(e):e||{}).endpoint&&(n.url=n.endpoint,delete n.endpoint),n.log){if(!r([n.log.info,n.log.warn,n.log.error,n.log.debug,n.log.json],o))throw new Error("expected log object to have error, debug, info, warn and json methods");this.log=n.log}else this.log={info:function(t){console.info("["+(new Date).toISOString()+"] INFO: "+t)},debug:function(t){console.debug("["+(new Date).toISOString()+"] DEBUG: "+t)},warn:function(t){console.warn("["+(new Date).toISOString()+"] WARN: "+t)},error:function(t){console.error("["+(new Date).toISOString()+"] ERROR: "+t)},json:function(t){console.log(JSON.stringify(t))}};this.stopped=!0,this.uploadState$=new i(!1),this.analyseState$=new i(!1),this.reportState$=new i(!1),this.instanceTelemetry$=new i(null),this.experimentalWorkerStatus$=new i(null),this.runningStates$=a(this.uploadState$,this.analyseState$,this.reportState$),this.states={upload:{filesCount:0,success:{files:0,bytes:0,reads:0},types:{},niceTypes:"",progress:{bytes:0,total:0}},download:{progress:{},success:{files:0,reads:0,bytes:0},fail:0,types:{},niceTypes:""},warnings:[]},this.liveStates$=new i(this.states),this.config={options:s(n,P),instance:{id_workflow_instance:n.id_workflow_instance,inputQueueName:null,outputQueueName:null,outputQueueURL:null,discoverQueueCache:{},bucket:null,bucketFolder:null,remote_addr:null,chain:null,key_id:null}},this.config.instance.awssettings={region:this.config.options.region},this.REST=new St(t({log:this.log},this.config.options)),this.graphQL=new bt(t({log:this.log},this.config.options)),this.timers={downloadCheckInterval:null,stateCheckInterval:null,fileCheckInterval:null,transferTimeouts:{},visibilityIntervals:{},summaryTelemetryInterval:null}}return e.prototype.socket=function(){return I(this,void 0,void 0,(function(){var e,n=this;return $(this,(function(r){return this.mySocket?[2,this.mySocket]:(this.mySocket=new jt(this.REST,t({log:this.log},this.config.options)),(e=this.config.instance.id_workflow_instance)&&this.mySocket.watch("workflow_instance:state:"+e,(function(t){var e=n.config.instance;if(e){var r=e.summaryTelemetry,o=Object.entries(e.chain.components).sort((function(t,e){return t[0]-e[0]})).reduce((function(e,n){var o=n[0],s=n[1];if(!t[o])return e;var i=+o,a=i&&Object.keys(r[s.wid])[0]||"ROOT",u=t[o].split(",").map((function(t){return Math.max(0,+t)}));return S(e,[{running:u[0],complete:u[1],error:u[2],step:i,name:a}])}),[]);n.experimentalWorkerStatus$.next(o)}})),[2,this.mySocket])}))}))},e.prototype.realtimeFeedback=function(t,e){return I(this,void 0,void 0,(function(){return $(this,(function(n){switch(n.label){case 0:return[4,this.socket()];case 1:return n.sent().emit(t,e),[2]}}))}))},e.prototype.stopTimer=function(t){this.timers[t]&&(this.log.debug("clearing "+t+" interval"),clearInterval(this.timers[t]),this.timers[t]=null)},e.prototype.stopAnalysis=function(){return I(this,void 0,void 0,(function(){var t,e;return $(this,(function(n){switch(n.label){case 0:if(this.stopUpload(),this.stopped=!0,!(t=this.config.instance.id_workflow_instance))return[3,8];n.label=1;case 1:return n.trys.push([1,6,,7]),this.config.options.graphQL?[4,this.graphQL.stopWorkflow({variables:{idWorkflowInstance:t}})]:[3,3];case 2:return n.sent(),[3,5];case 3:return[4,this.REST.stopWorkflow(t)];case 4:n.sent(),n.label=5;case 5:return this.analyseState$.next(!1),[3,7];case 6:return e=n.sent(),this.log.error("Error stopping instance: "+String(e)),[2,Promise.reject(e)];case 7:this.log.info("workflow instance "+t+" stopped"),n.label=8;case 8:return[2,Promise.resolve()]}}))}))},e.prototype.stopUpload=function(){return I(this,void 0,void 0,(function(){var t=this;return $(this,(function(e){return this.log.debug("stopping watchers"),["stateCheckInterval","fileCheckInterval"].forEach((function(e){return t.stopTimer(e)})),this.uploadState$.next(!1),[2]}))}))},e.prototype.stopEverything=function(){return I(this,void 0,void 0,(function(){var t=this;return $(this,(function(e){switch(e.label){case 0:return this.stopAnalysis(),Object.keys(this.timers.transferTimeouts).forEach((function(e){t.log.debug("clearing transferTimeout for "+e),clearTimeout(t.timers.transferTimeouts[e]),delete t.timers.transferTimeouts[e]})),Object.keys(this.timers.visibilityIntervals).forEach((function(e){t.log.debug("clearing visibilityInterval for "+e),clearInterval(t.timers.visibilityIntervals[e]),delete t.timers.visibilityIntervals[e]})),this.downloadWorkerPool?(this.log.debug("clearing downloadWorkerPool"),[4,Promise.all(Object.values(this.downloadWorkerPool))]):[3,2];case 1:e.sent(),this.downloadWorkerPool=null,e.label=2;case 2:return["summaryTelemetryInterval","downloadCheckInterval"].forEach((function(e){return t.stopTimer(e)})),[2]}}))}))},e.prototype.reportProgress=function(){var t=this.states,e=t.upload,n=t.download;this.log.json({progress:{download:n,upload:e}})},e.prototype.storeState=function(t,e,n,r){var o=this,s=r||{};this.states[t]||(this.states[t]={}),this.states[t][e]||(this.states[t][e]={}),"incr"===n?Object.keys(s).forEach((function(n){o.states[t][e][n]=o.states[t][e][n]?o.states[t][e][n]+parseInt(s[n],10):parseInt(s[n],10)})):Object.keys(s).forEach((function(n){o.states[t][e][n]=o.states[t][e][n]?o.states[t][e][n]-parseInt(s[n],10):-parseInt(s[n],10)}));try{this.states[t].success.niceReads=It(this.states[t].success.reads)}catch(a){this.states[t].success.niceReads=0}try{this.states[t].progress.niceSize=It(this.states[t].success.bytes+this.states[t].progress.bytes||0)}catch(a){this.states[t].progress.niceSize=0}try{this.states[t].success.niceSize=It(this.states[t].success.bytes)}catch(a){this.states[t].success.niceSize=0}this.states[t].niceTypes=Object.keys(this.states[t].types||{}).sort().map((function(e){return o.states[t].types[e]+" "+e})).join(", ");var i=Date.now();(!this.stateReportTime||i-this.stateReportTime>2e3)&&(this.stateReportTime=i,this.reportProgress()),this.liveStates$.next(b({},this.states))},e.prototype.uploadState=function(t,e,n){return this.storeState("upload",t,e,n)},e.prototype.downloadState=function(t,e,n){return this.storeState("download",t,e,n)},e.prototype.url=function(){return this.config.options.url},e.prototype.apikey=function(){return this.config.options.apikey},e.prototype.attr=function(t,e){if(!(t in this.config.options))throw new Error("config object does not contain property "+t);return e?(this.config.options[t]=e,this):this.config.options[t]},e.prototype.stats=function(t){return this.states[t]},e}();xt.version=kt.version,xt.Profile=$t,xt.REST=St,xt.utils=kt;export default xt;
